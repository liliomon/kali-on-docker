version: '3.8'

services:
  kali-linux:
    build:
      context: .
      dockerfile: Dockerfile.kali
    image: kali-gui:latest
    container_name: kali-linux-gui
    hostname: kali-team
    
    # Puerto RDP accesible desde cualquier equipo
    ports:
      - "3390:3390"
    
    # Mantener contenedor activo
    stdin_open: true
    tty: true
    
    # Reiniciar automáticamente si falla
    restart: unless-stopped
    
    # Volúmenes para persistencia de datos
    volumes:
      - kali-home:/home
      - kali-root:/root
      - kali-tools:/opt
      - kali-data:/var/lib
    
    # Variables de entorno
    environment:
      - DISPLAY=:1
      - DEBIAN_FRONTEND=noninteractive
      - TZ=America/Santiago
    
    # Red personalizada
    networks:
      - kali-network
    
    # Límites de recursos (opcional, ajustar según necesidad)
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G

# Volúmenes para persistencia de datos
volumes:
  kali-home:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/home
  kali-root:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/root
  kali-tools:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/tools
  kali-data:
    driver: local

# Red personalizada
networks:
  kali-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16
