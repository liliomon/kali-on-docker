version: '3.8'

services:
  kali-linux:
    image: kalilinux/kali-rolling
    container_name: kali-linux-gui
    hostname: kali-team
    
    # Puerto RDP accesible desde cualquier equipo
    ports:
      - "3390:3390"
    
    # Mantener contenedor activo
    stdin_open: true
    tty: true
    
    # Reiniciar automáticamente si falla
    restart: unless-stopped
    
    # Volúmenes para persistencia de datos
    volumes:
      - kali-home:/home
      - kali-root:/root
      - kali-tools:/opt
      - kali-data:/var/lib
    
    # Variables de entorno
    environment:
      - DISPLAY=:1
      - DEBIAN_FRONTEND=noninteractive
      - TZ=America/Santiago
    
    # Script de instalación y configuración automática
    command: >
      bash -c "
        echo '=== Iniciando instalación de Kali Linux con GUI ===' &&
        
        # Actualizar sistema
        apt update && apt upgrade -y &&
        
        # Instalar paquetes esenciales
        apt install -y sudo nano vim wget curl git net-tools iputils-ping &&
        
        # Instalar XRDP y componentes gráficos
        apt install -y xrdp xorgxrdp &&
        apt install -y kali-desktop-xfce xfce4 xfce4-goodies &&
        apt install -y dbus-x11 &&
        
        # Crear usuario con privilegios sudo
        useradd -m -s /bin/bash kaliuser &&
        echo 'kaliuser:kali123' | chpasswd &&
        usermod -aG sudo kaliuser &&
        echo 'kaliuser ALL=(ALL) NOPASSWD:ALL' > /etc/sudoers.d/kaliuser &&
        chmod 0440 /etc/sudoers.d/kaliuser &&
        
        # Configurar XRDP en puerto 3390
        sed -i 's/port=3389/port=3390/g' /etc/xrdp/xrdp.ini &&
        
        # Configurar sesión XFCE para el usuario
        su - kaliuser -c 'echo \"startxfce4\" > ~/.xsession && chmod +x ~/.xsession' &&
        
        # Configurar script de inicio de XRDP
        cat > /etc/xrdp/startwm.sh << 'XRDP_SCRIPT'
      #!/bin/sh
      unset SESSION_MANAGER
      unset DBUS_SESSION_BUS_ADDRESS
      export XDG_SESSION_TYPE=x11
      export XDG_RUNTIME_DIR=/tmp/runtime-\$(whoami)
      mkdir -p \$XDG_RUNTIME_DIR
      chmod 700 \$XDG_RUNTIME_DIR
      exec startxfce4
      XRDP_SCRIPT
        chmod +x /etc/xrdp/startwm.sh &&
        
        # Crear directorios necesarios
        mkdir -p /var/run/xrdp /var/log/xrdp &&
        
        # Iniciar servicios XRDP
        echo '=== Iniciando servicios XRDP ===' &&
        /usr/sbin/xrdp-sesman &&
        sleep 3 &&
        /usr/sbin/xrdp &&
        
        # Verificar servicios
        ps aux | grep xrdp &&
        netstat -tuln | grep 3390 &&
        
        echo '=== Instalación completada ===' &&
        echo 'Conecta con RDP a: localhost:3390' &&
        echo 'Usuario: kaliuser' &&
        echo 'Contraseña: kali123' &&
        
        # Mantener contenedor corriendo
        tail -f /dev/null
      "
    
    # Red personalizada
    networks:
      - kali-network
    
    # Límites de recursos (opcional, ajustar según necesidad)
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G

# Volúmenes para persistencia de datos
volumes:
  kali-home:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/home
  kali-root:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/root
  kali-tools:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/tools
  kali-data:
    driver: local

# Red personalizada
networks:
  kali-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16
